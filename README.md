# codeflix-video-encoder
Full Cycle 3.0 Final Project - Video Encoder


# Video Encoder Microservice

## Setting up the environment

To run in development mode, follow these steps:

* Duplicate the `.env.example` file and rename it to `.env`
* Run `docker-compose up -d`
* Access RabbitMQ administration and create an exchange of type `fanout`. This will be a `Dead Letter Exchange` to receive messages that were not processed.
* Create a `Dead Letter Queue` and bind it to the `Dead Letter Exchange` you just created. There is no need for a routing_key.
* In the `.env` file, specify the name of the `Dead Letter Exchange` in the parameter: `RABBITMQ_DLX`
* Create a service account on GCP that has permission to write to Google Cloud Storage. Download the JSON credentials file and save it in the project root with the exact name: `bucket-credential.json`

## Running

To run the encoder, execute the command `make server` directly inside the container. Example:

```
docker exec encoder-new2_app_1 make server
```

Note that `encoder-new2_app_1` is the name of the container generated by docker-compose.

## Message format for sending to the encoder

In order for a message to be parsed by the encoder system, it must be sent in the following JSON format:

```
{
  "resource_id": "my-resource-id-can-be-a-uuid-type",
  "file_path": "convite.mp4"
}
```

* `resource_id`: Represents the ID of the video you want to convert. It is a string.
* `file_path`: The full path of the MP4 video inside the bucket.

## Message format returned by the encoder

### Successful processing

For each processed video, the encoder will send the processing result to an exchange (configured in the .env file).

If processing is successfully completed, the return format in JSON will be:

```
{
    "id":"bbbdd123-ad05-4dc8-a74c-d63a0a2423d5",
    "output_bucket_path":"codeeducationtest",
    "status":"COMPLETED",
    "video":{
        "encoded_video_folder":"b3f2d41e-2c0a-4830-bd65-68227e97764f",
        "resource_id":"aadc5ff9-0b0d-13ab-4a40-a11b2eaa148c",
        "file_path":"convite.mp4"
    },
    "Error":"",
    "created_at":"2020-05-27T19:43:34.850479-04:00",
    "updated_at":"2020-05-27T19:43:38.081754-04:00"
}
```

Here, `encoded_video_folder` is the folder containing the converted video.

### Processing error

If the processing encountered an error, the return format in JSON will be:

```
{
    "message": {
        "resource_id": "aadc5ff9-010d-a3ab-4a40-a11b2eaa148c",
        "file_path": "convite.mp4"
    },
    "error":"Reason for the error"
}
```

Additionally, the encoder will send the original message that failed processing to a Dead Letter Exchange.
Simply configure the desired DLX in the `.env` file under the parameter: `RABBITMQ_DLX`
